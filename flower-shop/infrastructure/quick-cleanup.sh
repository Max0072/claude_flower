#!/bin/bash

# –°–∫—Ä–∏–ø—Ç –±—ã—Å—Ç—Ä–æ–π –æ—á–∏—Å—Ç–∫–∏ –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä–æ–≤ –æ–Ω–ª–∞–π–Ω-–º–∞–≥–∞–∑–∏–Ω–∞ —Ü–≤–µ—Ç–æ–≤ "–§–ª–æ—Ä–∞"

set -e

echo "üßπ –ù–∞—á–∏–Ω–∞–µ–º –æ—á–∏—Å—Ç–∫—É –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä–æ–≤ –æ–Ω–ª–∞–π–Ω-–º–∞–≥–∞–∑–∏–Ω–∞ —Ü–≤–µ—Ç–æ–≤ \"–§–ª–æ—Ä–∞\""

# –û–ø—Ä–µ–¥–µ–ª—è–µ–º –∫–æ—Ä–Ω–µ–≤—É—é –¥–∏—Ä–µ–∫—Ç–æ—Ä–∏—é –ø—Ä–æ–µ–∫—Ç–∞
ROOT_DIR="$(cd "$(dirname "${BASH_SOURCE[0]}")/.." && pwd)"

# –ü–µ—Ä–µ—Ö–æ–¥–∏–º –≤ –∫–æ—Ä–Ω–µ–≤—É—é –¥–∏—Ä–µ–∫—Ç–æ—Ä–∏—é –ø—Ä–æ–µ–∫—Ç–∞
cd "$ROOT_DIR/infrastructure"

echo "üìÇ –†–∞–±–æ—Ç–∞–µ–º —Å –¥–∏—Ä–µ–∫—Ç–æ—Ä–∏–µ–π: $ROOT_DIR/infrastructure"

# –û—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º –∏ —É–¥–∞–ª—è–µ–º –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä—ã
echo "üõë –û—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º –∏ —É–¥–∞–ª—è–µ–º –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä—ã..."
docker-compose -f docker-compose.yml down

# –°–ø—Ä–∞—à–∏–≤–∞–µ–º, –Ω—É–∂–Ω–æ –ª–∏ —É–¥–∞–ª–∏—Ç—å –≤—Å–µ —Ç–æ–º–∞ (–¥–∞–Ω–Ω—ã–µ)
read -p "‚ùì –£–¥–∞–ª–∏—Ç—å –≤—Å–µ –¥–∞–Ω–Ω—ã–µ (Docker volumes)? [y/N] " REMOVE_VOLUMES
if [[ $REMOVE_VOLUMES =~ ^[Yy]$ ]]; then
    echo "üóëÔ∏è –£–¥–∞–ª—è–µ–º –≤—Å–µ —Ç–æ–º–∞ —Å –¥–∞–Ω–Ω—ã–º–∏..."
    docker-compose -f docker-compose.yml down -v
    echo "‚úÖ –í—Å–µ —Ç–æ–º–∞ —É–¥–∞–ª–µ–Ω—ã"
fi

# –°–ø—Ä–∞—à–∏–≤–∞–µ–º, –Ω—É–∂–Ω–æ –ª–∏ —É–¥–∞–ª–∏—Ç—å –≤—Å–µ –æ–±—Ä–∞–∑—ã
read -p "‚ùì –£–¥–∞–ª–∏—Ç—å –≤—Å–µ Docker –æ–±—Ä–∞–∑—ã –ø—Ä–æ–µ–∫—Ç–∞? [y/N] " REMOVE_IMAGES
if [[ $REMOVE_IMAGES =~ ^[Yy]$ ]]; then
    echo "üóëÔ∏è –£–¥–∞–ª—è–µ–º –≤—Å–µ Docker –æ–±—Ä–∞–∑—ã –ø—Ä–æ–µ–∫—Ç–∞..."
    docker rmi $(docker images 'flora/*' -q) 2>/dev/null || echo "–û–±—Ä–∞–∑—ã –Ω–µ –Ω–∞–π–¥–µ–Ω—ã"
    echo "‚úÖ –í—Å–µ –æ–±—Ä–∞–∑—ã –ø—Ä–æ–µ–∫—Ç–∞ —É–¥–∞–ª–µ–Ω—ã"
fi

# –°–ø—Ä–∞—à–∏–≤–∞–µ–º, –Ω—É–∂–Ω–æ –ª–∏ –æ—á–∏—Å—Ç–∏—Ç—å –Ω–µ–∏—Å–ø–æ–ª—å–∑—É–µ–º—ã–µ –æ–±—Ä–∞–∑—ã, –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä—ã –∏ —Å–µ—Ç–∏
read -p "‚ùì –í—ã–ø–æ–ª–Ω–∏—Ç—å –ø–æ–ª–Ω—É—é –æ—á–∏—Å—Ç–∫—É Docker (prune)? [y/N] " PRUNE_DOCKER
if [[ $PRUNE_DOCKER =~ ^[Yy]$ ]]; then
    echo "üßπ –í—ã–ø–æ–ª–Ω—è–µ–º –ø–æ–ª–Ω—É—é –æ—á–∏—Å—Ç–∫—É Docker..."
    docker system prune -f
    echo "‚úÖ –û—á–∏—Å—Ç–∫–∞ –∑–∞–≤–µ—Ä—à–µ–Ω–∞"
fi

echo ""
echo "‚úÖ –û—á–∏—Å—Ç–∫–∞ –∑–∞–≤–µ—Ä—à–µ–Ω–∞! –í—Å–µ –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä—ã –æ—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω—ã –∏ —É–¥–∞–ª–µ–Ω—ã."
echo "–î–ª—è –ø–æ–≤—Ç–æ—Ä–Ω–æ–≥–æ –∑–∞–ø—É—Å–∫–∞ –ø—Ä–æ–µ–∫—Ç–∞ –∏—Å–ø–æ–ª—å–∑—É–π—Ç–µ —Å–∫—Ä–∏–ø—Ç deploy.sh"